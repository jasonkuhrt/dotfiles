#!/usr/bin/env bash
# Copy common gitignored files from source to target worktree directory.
# Auto-detects which tools/files are present and copies accordingly.
#
# Usage: copy-env <source-dir> <target-dir>
#
# Handles:
#   .env, .env.local           - Environment variables
#   .claude/settings.local.json - Claude Code local permissions
#   .serena/                    - Serena MCP project config + cache
#   .envrc                      - direnv (pre-approves in target)
#   tsconfig.tsbuildinfo        - TypeScript build cache (warm start)

set -euo pipefail

SOURCE="${1:?Usage: copy-env <source-dir> <target-dir>}"
TARGET="${2:?Usage: copy-env <source-dir> <target-dir>}"

copied=()

# --- Environment files ---
for f in .env .env.local; do
  if [[ -f "$SOURCE/$f" ]]; then
    cp "$SOURCE/$f" "$TARGET/$f"
    copied+=("$f")
  fi
done

# --- Claude Code ---
if [[ -f "$SOURCE/.claude/settings.local.json" ]]; then
  mkdir -p "$TARGET/.claude"
  cp "$SOURCE/.claude/settings.local.json" "$TARGET/.claude/settings.local.json"
  copied+=(".claude/settings.local.json")
fi

# --- Serena MCP ---
if [[ -d "$SOURCE/.serena" ]]; then
  mkdir -p "$TARGET/.serena"
  # Project config (use template if available, else copy as-is)
  if [[ -f "$SOURCE/.serena/project.template.yml" ]]; then
    cp "$SOURCE/.serena/project.template.yml" "$TARGET/.serena/project.yml"
    copied+=(".serena/project.yml (from template)")
  elif [[ -f "$SOURCE/.serena/project.yml" ]]; then
    cp "$SOURCE/.serena/project.yml" "$TARGET/.serena/project.yml"
    copied+=(".serena/project.yml")
  fi
  # Rename project to avoid LSP conflicts between worktrees
  if [[ -f "$TARGET/.serena/project.yml" ]]; then
    SUFFIX=$(basename "$TARGET")
    sed -i '' "s/project_name: \"\\([^\"]*\\)\"/project_name: \"\\1-$SUFFIX\"/" \
      "$TARGET/.serena/project.yml" 2>/dev/null || true
  fi
  # Cache (avoids re-indexing delay)
  if [[ -d "$SOURCE/.serena/cache" ]]; then
    cp -r "$SOURCE/.serena/cache" "$TARGET/.serena/cache"
    copied+=(".serena/cache/")
  fi
fi

# --- direnv ---
if [[ -f "$SOURCE/.envrc" ]]; then
  # .envrc is tracked (not copied), but needs pre-approval in target
  if command -v direnv &>/dev/null; then
    direnv allow "$TARGET/.envrc" 2>/dev/null || true
    copied+=(".envrc (pre-approved)")
  fi
fi

# --- TypeScript build cache ---
if [[ -d "$SOURCE/apps" ]]; then
  found_tsbuildinfo=false
  while IFS= read -r -d '' f; do
    found_tsbuildinfo=true
    break
  done < <(find "$SOURCE/apps" -name 'tsconfig.tsbuildinfo' -print0 2>/dev/null)

  if $found_tsbuildinfo; then
    rsync -a --include='*/' --include='tsconfig.tsbuildinfo' --exclude='*' --prune-empty-dirs \
      "$SOURCE/apps/" "$TARGET/apps/" 2>/dev/null || true
    copied+=("apps/**/tsconfig.tsbuildinfo")
  fi
fi

# --- Report ---
if [[ ${#copied[@]} -gt 0 ]]; then
  echo "Copied to worktree:"
  for item in "${copied[@]}"; do
    echo "  $item"
  done
else
  echo "No gitignored files found to copy."
fi
