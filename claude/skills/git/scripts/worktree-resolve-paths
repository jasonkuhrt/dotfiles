#!/usr/bin/env bash
# Resolve worktree-related paths.
# Outputs JSON: { "mainRepo", "currentDir", "worktreeDir", "isWorktree" }
#
# Usage: resolve-paths <branch-name>
#   branch-name: Name for the worktree directory (e.g. "feat-HEA-1234-dark-mode")

set -euo pipefail

BRANCH_NAME="${1:?Usage: resolve-paths <branch-name>}"

CURRENT_DIR=$(pwd)
GIT_COMMON_DIR=$(git rev-parse --git-common-dir)
GIT_DIR=$(git rev-parse --git-dir)

# Detect if we're in a worktree
IS_WORKTREE=false
if [[ "$GIT_COMMON_DIR" != "$GIT_DIR" ]]; then
  IS_WORKTREE=true
fi

# Resolve main repo path (works from worktree or main repo)
MAIN_REPO=$(echo "$GIT_COMMON_DIR" | sed 's|/.git$||')
if [[ "$MAIN_REPO" == */.git/worktrees/* ]]; then
  MAIN_REPO=$(echo "$MAIN_REPO" | sed 's|/.git/worktrees/.*||')
fi

WORKTREE_DIR="$MAIN_REPO/.worktrees/$BRANCH_NAME"

cat <<EOF
{
  "mainRepo": "$MAIN_REPO",
  "currentDir": "$CURRENT_DIR",
  "worktreeDir": "$WORKTREE_DIR",
  "isWorktree": $IS_WORKTREE
}
EOF
