#!/usr/bin/env bash
# Get build logs for a Vercel deployment
# Usage: get-build-logs <uid|url> [--flush]
# --flush writes logs to .clauding/vercel/{timestamp}-{branch}-{short-uid}.log

set -euo pipefail

# Config
PROJECT_ROOT=$(git rev-parse --show-toplevel)
DATA_FILE="$PROJECT_ROOT/.claude/vercel.json"
AUTH_FILE="$HOME/Library/Application Support/com.vercel.cli/auth.json"

if [[ ! -f "$DATA_FILE" ]]; then
  echo '{"error": "Missing .claude/vercel.json in project root. Must contain teamId and project."}' >&2
  exit 1
fi

TEAM_ID=$(jq -r '.teamId' "$DATA_FILE")
PROJECT=$(jq -r '.project' "$DATA_FILE")

# Parse args
FLUSH=false
INPUT=""
for arg in "$@"; do
  case "$arg" in
    --flush) FLUSH=true ;;
    *) INPUT="$arg" ;;
  esac
done

if [[ -z "$INPUT" ]]; then
  echo '{"error": "Usage: get-build-logs <uid|url> [--flush]"}' >&2
  exit 1
fi

# Get token
if [[ ! -f "$AUTH_FILE" ]]; then
  echo '{"error": "Not logged in. Run: npx vercel login"}' >&2
  exit 1
fi
TOKEN=$(jq -r '.token' "$AUTH_FILE")

# Resolve uid and branch from URL if needed
BRANCH=""
if [[ "$INPUT" == dpl_* ]]; then
  DEPLOY_UID="$INPUT"
  # Look up branch from deployments API
  DEPLOY_INFO=$(curl -s "https://api.vercel.com/v13/deployments/$DEPLOY_UID?teamId=$TEAM_ID" \
    -H "Authorization: Bearer $TOKEN")
  BRANCH=$(echo "$DEPLOY_INFO" | jq -r '.meta.githubCommitRef // "unknown"')
else
  # Extract URL subdomain
  URL="${INPUT%.vercel.app}"
  URL="${URL#https://}"
  URL="${URL#http://}"

  # Look up uid and branch from deployments API
  DEPLOY_INFO=$(curl -s "https://api.vercel.com/v6/deployments?projectId=$PROJECT&teamId=$TEAM_ID&limit=100" \
    -H "Authorization: Bearer $TOKEN" | jq --arg url "$URL.vercel.app" '.deployments[] | select(.url == $url)')

  DEPLOY_UID=$(echo "$DEPLOY_INFO" | jq -r '.uid')
  BRANCH=$(echo "$DEPLOY_INFO" | jq -r '.meta.githubCommitRef // "unknown"')

  if [[ -z "$DEPLOY_UID" || "$DEPLOY_UID" == "null" ]]; then
    echo "{\"error\": \"Deployment not found for URL: $INPUT\"}" >&2
    exit 1
  fi
fi

# Fetch build logs
LOGS=$(curl -s "https://api.vercel.com/v2/deployments/$DEPLOY_UID/events?builds=1&teamId=$TEAM_ID" \
  -H "Authorization: Bearer $TOKEN" | jq '[.[] | select(.type == "stdout") | .payload.text]')

# Output or flush
if [[ "$FLUSH" == true ]]; then
  # Generate filename: {YYYY-MM-DD}-{HHMM}-{branch}-{short-uid}.log
  TIMESTAMP=$(date -u +"%Y-%m-%d-%H%M")
  SAFE_BRANCH=$(echo "$BRANCH" | tr '/' '-' | tr '[:upper:]' '[:lower:]')
  SHORT_UID="${DEPLOY_UID#dpl_}"
  SHORT_UID="${SHORT_UID:0:8}"

  LOG_DIR=".clauding/vercel"
  LOG_FILE="$LOG_DIR/${TIMESTAMP}-${SAFE_BRANCH}-${SHORT_UID}.log"

  mkdir -p "$LOG_DIR"

  # Write logs as plain text (one line per entry)
  echo "$LOGS" | jq -r '.[]' > "$LOG_FILE"

  # Output result JSON
  cat <<EOF
{
  "flushed": true,
  "file": "$LOG_FILE",
  "uid": "$DEPLOY_UID",
  "branch": "$BRANCH",
  "lines": $(echo "$LOGS" | jq 'length')
}
EOF
else
  echo "$LOGS"
fi
