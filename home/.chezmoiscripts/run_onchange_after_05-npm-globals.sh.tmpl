#!/bin/bash
# chezmoi:template:left-delimiter="{{" right-delimiter="}}"
set -e

# npm globals hash: {{ include "npm/global-packages.txt" | sha256sum }}

{{ template "helpers.sh" . }}

header "npm Global Packages"

# Ensure Homebrew and pnpm node are in PATH
if [ -f "/opt/homebrew/bin/brew" ]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi
PNPM_HOME="$HOME/Library/pnpm"
export PATH="$PNPM_HOME:$PATH"

if ! has_cmd npm; then
    warn "npm not installed, skipping global packages"
    exit 0
fi

mkdir -p "$HOME/.npm-global/bin"

GLOBALS_FILE="{{ .chezmoi.sourceDir }}/npm/global-packages.txt"

info "Installing global packages to ~/.npm-global..."
while IFS= read -r item || [ -n "$item" ]; do
    [[ "$item" =~ ^#.*$ || -z "$item" ]] && continue
    if npm list -g "$item" &>/dev/null; then
        skip "$item"
    else
        if npm install -g "$item" &>/dev/null; then
            task "$item"
        else
            warn "Failed to install $item"
        fi
    fi
done < "$GLOBALS_FILE"

info "Upgrading global packages to latest..."
if npm update -g &>/dev/null; then
    task "Global packages upgraded"
else
    warn "npm update -g failed"
fi
