#!/bin/bash
# chezmoi:template:left-delimiter="{{" right-delimiter="}}"
set -e

{{ template "helpers.sh" . }}

{{ if eq .chezmoi.os "darwin" }}

header "macOS Defaults"

info "Configuring keyboard..."
set_default "com.apple.HIToolbox" "AppleFnUsageType" "-int" "3" "Fn/Globe key press does nothing (disable Emoji picker)"
set_default "NSGlobalDomain" "com.apple.keyboard.fnState" "-bool" "true" "Use F1, F2, etc. as standard function keys"
set_default "NSGlobalDomain" "ApplePressAndHoldEnabled" "-bool" "false" "Key repeat enabled"
set_default "NSGlobalDomain" "KeyRepeat" "-int" "2" "Fast key repeat rate"
set_default "NSGlobalDomain" "InitialKeyRepeat" "-int" "15" "Short initial key repeat delay"
set_default "NSGlobalDomain" "NSAutomaticPeriodSubstitutionEnabled" "-bool" "false" "Disabled double-space period"
set_default "NSGlobalDomain" "NSAutomaticQuoteSubstitutionEnabled" "-bool" "false" "Disabled smart quotes"
set_default "NSGlobalDomain" "NSAutomaticDashSubstitutionEnabled" "-bool" "false" "Disabled smart dashes"
set_default "NSGlobalDomain" "NSAutomaticSpellingCorrectionEnabled" "-bool" "false" "Disabled auto-correct"
set_default "NSGlobalDomain" "AppleKeyboardUIMode" "-int" "3" "Full keyboard access (Tab in dialogs)"

info "Configuring screenshots..."
mkdir -p "$HOME/Pictures/Screenshots"
set_default "com.apple.screencapture" "location" "-string" "$HOME/Pictures/Screenshots" "Screenshots save to ~/Pictures/Screenshots"

info "Configuring Finder..."
set_default "NSGlobalDomain" "AppleShowAllExtensions" "-bool" "true" "Show all file extensions"
set_default "com.apple.finder" "FXEnableExtensionChangeWarning" "-bool" "false" "No extension change warning"
set_default "com.apple.finder" "AppleShowAllFiles" "-bool" "true" "Show hidden files"
set_default "com.apple.finder" "ShowPathbar" "-bool" "true" "Show path bar"
set_default "com.apple.finder" "_FXSortFoldersFirst" "-bool" "true" "Folders on top when sorting"
set_default "com.apple.desktopservices" "DSDontWriteNetworkStores" "-bool" "true" "No .DS_Store on network volumes"
set_default "com.apple.desktopservices" "DSDontWriteUSBStores" "-bool" "true" "No .DS_Store on USB volumes"

info "Configuring system..."
set_default "com.apple.LaunchServices" "LSQuarantine" "-bool" "false" "Disabled app quarantine dialog"
set_default "com.apple.dock" "minimize-to-application" "-bool" "true" "Minimize to app icon"
set_default "com.apple.dock" "show-recents" "-bool" "false" "No recent apps in Dock"
set_default "com.apple.dock" "autohide" "-bool" "true" "Dock autohide"
set_default "com.apple.dock" "tilesize" "-int" "36" "Dock icon size (smaller)"
set_default "com.apple.dock" "mineffect" "-string" "scale" "Scale effect (not genie)"

info "Configuring trackpad..."
set_default "com.apple.AppleMultitouchTrackpad" "Clicking" "-bool" "true" "Tap to click (trackpad)"
set_default "com.apple.driver.AppleBluetoothMultitouch.trackpad" "Clicking" "-bool" "true" "Tap to click (bluetooth)"

info "Configuring Mission Control..."
set_default "com.apple.dock" "mru-spaces" "-bool" "false" "Disable auto-rearrange Spaces"

info "Checking iCloud Desktop & Documents..."
icloud_desktop=$(defaults read com.apple.finder FXICloudDriveDesktop 2>/dev/null || echo "0")
icloud_docs=$(defaults read com.apple.finder FXICloudDriveDocuments 2>/dev/null || echo "0")
if [ "$icloud_desktop" = "1" ] && [ "$icloud_docs" = "1" ]; then
    skip "iCloud Desktop & Documents"
else
    warn "iCloud Desktop & Documents not enabled - enable manually:"
    printf "      ${DIM}System Settings → Apple ID → iCloud → iCloud Drive → Options → check \"Desktop & Documents Folders\"${RESET}\n"
fi

info "Settings applied. Finder/Dock changes take effect on login, or run: killall Finder && killall Dock"

{{ else }}
# Not macOS — skip
:
{{ end }}
