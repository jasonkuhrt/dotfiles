#!/bin/bash
# chezmoi:template:left-delimiter="{{" right-delimiter="}}"
set -e

{{ template "helpers.sh" . }}

header "Skills Sync (agents/codex)"

# Mirror ~/.claude/skills/ to ~/.agents/skills/ and ~/.codex/skills/
# Preserves .system directory (Codex system skills)

SKILLS_SRC="$HOME/.claude/skills"

for target_root in "$HOME/.agents" "$HOME/.codex"; do
    target_dir="$target_root/skills"
    target_name=$(basename "$target_root")
    mkdir -p "$target_dir"

    # Remove stale symlinks (skills that no longer exist in source)
    if [ -d "$target_dir" ]; then
        for link in "$target_dir"/*; do
            [ -e "$link" ] || [ -L "$link" ] || continue
            name=$(basename "$link")
            [ "$name" = ".system" ] && continue
            if [ ! -d "$SKILLS_SRC/$name" ]; then
                rm -rf "$link"
                info "Removed stale $target_name/skills/$name"
            fi
        done
    fi

    # Create/update symlinks for each skill
    for skill_dir in "$SKILLS_SRC"/*/; do
        [ -d "$skill_dir" ] || continue
        name=$(basename "$skill_dir")
        [ "$name" = ".system" ] && continue

        dest="$target_dir/$name"
        # Use relative symlink: ../../.claude/skills/<name>
        rel_target="../../.claude/skills/$name"

        if [ -L "$dest" ] && [ "$(readlink "$dest")" = "$rel_target" ]; then
            continue  # Already correct
        fi

        # Remove existing (wrong symlink or real dir)
        [ -e "$dest" ] || [ -L "$dest" ] && rm -rf "$dest"

        ln -s "$rel_target" "$dest"
    done

    task "$target_name/skills synced"
done
