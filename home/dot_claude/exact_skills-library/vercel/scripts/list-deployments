#!/usr/bin/env bash
# List Vercel deployments via API
# Usage: list-deployments [--pr=N] [--branch=name] [--limit=N]

set -euo pipefail

# Config
PROJECT_ROOT=$(git rev-parse --show-toplevel)
DATA_FILE="$PROJECT_ROOT/.claude/vercel.json"
AUTH_FILE="$HOME/Library/Application Support/com.vercel.cli/auth.json"

if [[ ! -f "$DATA_FILE" ]]; then
  echo '{"error": "Missing .claude/vercel.json in project root. Must contain teamId and project."}' >&2
  exit 1
fi

TEAM_ID=$(jq -r '.teamId' "$DATA_FILE")
PROJECT=$(jq -r '.project' "$DATA_FILE")

# Parse args
PR=""
BRANCH=""
LIMIT=30

for arg in "$@"; do
  case $arg in
    --pr=*) PR="${arg#*=}" ;;
    --branch=*) BRANCH="${arg#*=}" ;;
    --limit=*) LIMIT="${arg#*=}" ;;
  esac
done

# Get token
if [[ ! -f "$AUTH_FILE" ]]; then
  echo '{"error": "Not logged in. Run: npx vercel login"}' >&2
  exit 1
fi
TOKEN=$(jq -r '.token' "$AUTH_FILE")

# Fetch deployments
RESPONSE=$(curl -s "https://api.vercel.com/v6/deployments?projectId=$PROJECT&teamId=$TEAM_ID&target=preview&limit=$LIMIT" \
  -H "Authorization: Bearer $TOKEN")

# Build jq filter
FILTER='.deployments | map(select(.state == "READY"))'

if [[ -n "$PR" ]]; then
  FILTER="$FILTER | map(select(.meta.githubPrId == \"$PR\"))"
fi

if [[ -n "$BRANCH" ]]; then
  FILTER="$FILTER | map(select(.meta.githubCommitRef == \"$BRANCH\"))"
fi

# Output: list deployments with build duration
echo "$RESPONSE" | jq "$FILTER"' | map({
  uid: .uid,
  url: .url,
  branch: .meta.githubCommitRef,
  pr: .meta.githubPrId,
  commit: .meta.githubCommitSha[0:7],
  author: .meta.githubCommitAuthorLogin,
  duration_min: (((.ready - .buildingAt) / 1000 / 60) | . * 10 | floor / 10),
  created: (.createdAt / 1000 | strftime("%Y-%m-%d %H:%M"))
})'
