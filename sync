#!/bin/bash
set -e

# ─────────────────────────────────────────────────────────────
# Dotfiles installer
# Works for both fresh installs and syncing existing machines
# ─────────────────────────────────────────────────────────────

HERE="$(cd "$(dirname "$0")" && pwd)"

# Load shared utilities
source "$HERE/sync-lib.sh"

# Parse arguments
VERBOSE=false
RUN_MIGRATE=false
MIGRATE_ONLY=false
for arg in "$@"; do
    case $arg in
        -v|--verbose) VERBOSE=true ;;
        --migrate) RUN_MIGRATE=true ;;
        --migrate-only) RUN_MIGRATE=true; MIGRATE_ONLY=true ;;
    esac
done

# Log file for full output (used by run_logged from sync-lib.sh)
LOG_FILE="/tmp/dotfiles-sync-$(date +%Y%m%d-%H%M%S).log"
touch "$LOG_FILE"

# ─────────────────────────────────────────────────────────────
# Main
# ─────────────────────────────────────────────────────────────

printf "\n"
printf "${BOLD}${CYAN}╔══════════════════════════════════════╗${RESET}\n"
printf "${BOLD}${CYAN}║${RESET}            ${BOLD}Dotfiles Sync${RESET}             ${BOLD}${CYAN}║${RESET}\n"
printf "${BOLD}${CYAN}╚══════════════════════════════════════╝${RESET}\n"
printf "${DIM}%s${RESET}\n" "$HERE"
if $VERBOSE; then
    printf "${DIM}Verbose mode enabled${RESET}\n"
fi
if $MIGRATE_ONLY; then
    printf "${DIM}Migration only mode${RESET}\n"
fi
printf "${DIM}Log: %s${RESET}\n" "$LOG_FILE"

# Skip to migrations section if --migrate-only
if $MIGRATE_ONLY; then
    # Jump to migrations (uses labeled section at end of script)
    :
else

# ─────────────────────────────────────────────────────────────
header "Claude Code"

ensure_real_dir "$HOME/.claude" "$HERE/claude"
link_file "$HERE/claude/CLAUDE.md" "$HOME/.claude/CLAUDE.md" "claude/CLAUDE.md"
link_file "$HERE/claude/settings.json" "$HOME/.claude/settings.json" "claude/settings.json"
link_subdir "$HERE/claude/commands" "$HOME/.claude/commands" "claude/commands"
link_subdir "$HERE/claude/rules" "$HOME/.claude/rules" "claude/rules"
link_subdir "$HERE/claude/skills" "$HOME/.claude/skills" "claude/skills"
link_subdir "$HERE/claude/scripts" "$HOME/.claude/scripts" "claude/scripts"

# ─────────────────────────────────────────────────────────────
header "Zed"

ensure_real_dir "$HOME/.config/zed" "$HERE/zed"
link_file "$HERE/zed/settings.json" "$HOME/.config/zed/settings.json" "zed/settings.json"
link_file "$HERE/zed/keymap.json" "$HOME/.config/zed/keymap.json" "zed/keymap.json"
link_file "$HERE/zed/tasks.json" "$HOME/.config/zed/tasks.json" "zed/tasks.json"
link_file "$HERE/zed/toggle-chore-files.sh" "$HOME/.config/zed/toggle-chore-files.sh" "zed/toggle-chore-files.sh"
link_subdir "$HERE/zed/snippets" "$HOME/.config/zed/snippets" "zed/snippets"

# ─────────────────────────────────────────────────────────────
header "Ghostty"

ensure_real_dir "$HOME/.config/ghostty" "$HERE/ghostty"
link_file "$HERE/ghostty/config" "$HOME/.config/ghostty/config" "ghostty/config"

# ─────────────────────────────────────────────────────────────
header "Lazygit"

ensure_real_dir "$HOME/.config/lazygit" "$HERE/lazygit"
link_file "$HERE/lazygit/config.yml" "$HOME/.config/lazygit/config.yml" "lazygit/config.yml"

# ─────────────────────────────────────────────────────────────
header "Neovim"

ensure_real_dir "$HOME/.config/nvim" "$HERE/nvim"
link_file "$HERE/nvim/init.vim" "$HOME/.config/nvim/init.vim" "nvim/init.vim"

# ─────────────────────────────────────────────────────────────
header "Config Files"

link_file "$HERE/ssh/config" "$HOME/.ssh/config" "ssh/config"
mkdir -p "$HOME/.ssh/sockets"  # for ControlMaster multiplexing

# Add GitHub's SSH host keys (avoid authenticity prompt)
ensure_in_file "github.com" "$HOME/.ssh/known_hosts" \
    "ssh-keyscan -t ed25519,rsa github.com >> '$HOME/.ssh/known_hosts' 2>/dev/null" \
    "GitHub known_hosts"

mkdir -p "$HOME/.config/vim"
link_file "$HERE/vim/vimrc" "$HOME/.config/vim/.vimrc" "vim/.vimrc"
link_file "$HERE/npmrc" "$HOME/.npmrc" ".npmrc"
mkdir -p "$HOME/.config/dprint"
link_file "$HERE/dprint/dprint.json" "$HOME/.config/dprint/dprint.json" "dprint/dprint.json"
if has_cmd dprint; then
    dprint config update --config "$HOME/.config/dprint/dprint.json" 2>/dev/null
    info "dprint plugins checked"
fi

link_file "$HERE/starship/starship.toml" "$HOME/.config/starship.toml" "starship.toml"

mkdir -p "$HOME/.config/gh"
link_file "$HERE/gh/config.yml" "$HOME/.config/gh/config.yml" "gh/config.yml"

mkdir -p "$HOME/.config/libra"
link_file "$HERE/libra/config.json" "$HOME/.config/libra/config.json" "libra/config.json"

mkdir -p "$HOME/.config/direnv"
link_file "$HERE/direnv/direnv.toml" "$HOME/.config/direnv/direnv.toml" "direnv/direnv.toml"

# ─────────────────────────────────────────────────────────────
header "AWS"

mkdir -p "$HOME/.aws"

# Create credentials file from template if missing
if [ ! -f "$HERE/aws/credentials" ]; then
    cp "$HERE/aws/credentials.example" "$HERE/aws/credentials"
    task "Created aws/credentials from template"
    warn "Edit aws/credentials to add your access keys"
fi

link_file "$HERE/aws/config" "$HOME/.aws/config" "aws/config"
link_file "$HERE/aws/credentials" "$HOME/.aws/credentials" "aws/credentials"

# ─────────────────────────────────────────────────────────────
header "Fish Shell"

mkdir -p "$HOME/.config/fish"

# Create secrets file from template if missing
if [ ! -f "$HERE/fish/config.secrets.fish" ]; then
    cp "$HERE/fish/config.secrets.fish.example" "$HERE/fish/config.secrets.fish"
    task "Created config.secrets.fish from template"
    warn "Edit fish/config.secrets.fish to add your tokens"
fi

link_file "$HERE/fish/config.fish" "$HOME/.config/fish/config.fish" "config.fish"
link_file "$HERE/fish/config.secrets.fish" "$HOME/.config/fish/config.secrets.fish" "config.secrets.fish"
link_file "$HERE/fish/modules" "$HOME/.config/fish/modules" "fish/modules"
# fish_plugins handled separately in Fisher section (copy, not symlink)

# Fisher plugins installed after Homebrew (which installs fish)

# ─────────────────────────────────────────────────────────────
header "Git"

link_file "$HERE/git/.gitconfig" "$HOME/.gitconfig" ".gitconfig"

mkdir -p "$HOME/.config/git"
link_file "$HERE/git/ignore" "$HOME/.config/git/ignore" "git/ignore"

# GitHub CLI protocol
if has_cmd gh; then
    current_protocol=$(gh config get git_protocol 2>/dev/null || echo "")
    if [ "$current_protocol" = "ssh" ]; then
        skip "GitHub CLI protocol"
    else
        gh config set git_protocol ssh 2>/dev/null
        task "GitHub CLI protocol set to SSH"
    fi

    # Fix dotfiles repo remote (cloned via HTTPS before this ran)
    current_remote=$(git -C "$HERE" remote get-url origin 2>/dev/null || echo "")
    expected_remote="git@github.com:jasonkuhrt/dotfiles.git"
    if [ "$current_remote" = "$expected_remote" ]; then
        skip "Dotfiles remote"
    else
        git -C "$HERE" remote set-url origin "$expected_remote" 2>/dev/null
        task "Dotfiles remote set to SSH"
    fi
else
    skip "GitHub CLI (not installed)"
fi

# ─────────────────────────────────────────────────────────────
header "Misc"

mkdir -p "$HOME/.local/bin"

# Hush login message
ensure_file "$HOME/.hushlogin" ".hushlogin"

# ─────────────────────────────────────────────────────────────
header "Xcode CLI Tools"

if xcode-select -p &>/dev/null; then
    skip "Xcode CLI tools"
else
    info "Installing Xcode CLI tools..."
    xcode-select --install
    # Wait for installation to complete
    until xcode-select -p &>/dev/null; do
        sleep 5
    done
    task "Xcode CLI tools installed"
fi

# ─────────────────────────────────────────────────────────────
header "Homebrew"

# Ensure Homebrew is in PATH for this session (Apple Silicon)
if [ -f "/opt/homebrew/bin/brew" ]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi

if ! has_cmd brew; then
    info "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

    # Add brew to PATH after install
    if [ -f "/opt/homebrew/bin/brew" ]; then
        eval "$(/opt/homebrew/bin/brew shellenv)"
    fi
    task "Homebrew installed"
else
    skip "Homebrew"
fi

# Check what needs to be installed
if brew bundle check --file="$HERE/Brewfile" &>/dev/null; then
    skip "Homebrew packages"
else
    # Show what will be installed
    info "Checking what needs to be installed..."
    missing=$(brew bundle check --file="$HERE/Brewfile" 2>&1 | grep -E "^(brew|cask|mas)" || true)
    if [ -n "$missing" ]; then
        echo "$missing" | while read -r line; do
            printf "    ${DIM}%s${RESET}\n" "$line"
        done
    fi

    # Install formulae first (no sudo needed)
    # Skip casks and MAS apps - they're handled separately below
    info "Installing formulae..."
    if HOMEBREW_BUNDLE_CASK_SKIP=1 HOMEBREW_BUNDLE_MAS_SKIP=1 run_logged "Homebrew formulae" brew bundle --file="$HERE/Brewfile"; then
        task "Formulae installed"
    else
        warn "Some formulae may have failed (see $LOG_FILE)"
    fi

    # Install casks separately with context (these may need sudo)
    info "Installing casks (may prompt for password)..."
    # Install each cask individually so user knows which one is asking
    grep -E "^cask " "$HERE/Brewfile" | sed 's/cask "//;s/".*//' | while read -r cask; do
        if ! brew list --cask "$cask" &>/dev/null; then
            printf "    ${DIM}Installing %s...${RESET}\n" "$cask"
            if brew install --cask "$cask" >> "$LOG_FILE" 2>&1; then
                task "$cask"
            else
                warn "Failed to install $cask (see $LOG_FILE)"
            fi
        fi
    done

    # Install Mac App Store apps
    if grep -qE "^mas " "$HERE/Brewfile"; then
        info "Installing Mac App Store apps..."
        if HOMEBREW_BUNDLE_BREW_SKIP=1 HOMEBREW_BUNDLE_CASK_SKIP=1 run_logged "Mac App Store" brew bundle --file="$HERE/Brewfile"; then
            task "Mac App Store apps installed"
        else
            warn "Some MAS apps may have failed (see $LOG_FILE)"
        fi
    fi
fi

# ─────────────────────────────────────────────────────────────
header "Node.js"

# pnpm manages node versions; brew's node is just for bootstrapping pnpm
# See README "Node Package Management" for details
PNPM_HOME="$HOME/Library/pnpm"
if has_cmd pnpm; then
    if [ ! -d "$PNPM_HOME/nodejs" ]; then
        info "Installing Node.js LTS via pnpm..."
        if run_logged "pnpm env" pnpm env use --global lts; then
            task "Node.js LTS installed"
        else
            warn "pnpm env failed (see $LOG_FILE)"
        fi
    else
        skip "Node.js LTS (already managed by pnpm)"
    fi
    # Add pnpm's node to PATH for rest of this script
    export PATH="$PNPM_HOME:$PATH"
else
    warn "pnpm not installed, skipping Node.js setup"
fi

# ─────────────────────────────────────────────────────────────
header "Fisher Plugins"

# Now fish is installed via Homebrew, set up Fisher
if has_cmd fish; then
    if [ ! -f "$HOME/.config/fish/functions/fisher.fish" ]; then
        info "Installing Fisher plugin manager..."
        if run_logged "Fisher install" fish -c 'curl -sL https://git.io/fisher | source && fisher install jorgebucaran/fisher'; then
            task "Fisher installed"
        else
            warn "Fisher install failed (see $LOG_FILE)"
        fi
    else
        skip "Fisher"
    fi

    # Sync fish_plugins (copy, not symlink - protects dotfiles from fisher corruption)
    FISH_PLUGINS_SRC="$HERE/fish/fish_plugins"
    FISH_PLUGINS_DST="$HOME/.config/fish/fish_plugins"

    if [ -f "$FISH_PLUGINS_DST" ] && [ ! -L "$FISH_PLUGINS_DST" ]; then
        # Local file exists and is not a symlink - check for drift
        if ! diff -q "$FISH_PLUGINS_SRC" "$FISH_PLUGINS_DST" >/dev/null 2>&1; then
            warn "Local fish_plugins differs from dotfiles:"
            diff "$FISH_PLUGINS_SRC" "$FISH_PLUGINS_DST" || true
            printf "      ${DIM}If you added plugins locally, update dotfiles/fish/fish_plugins${RESET}\n"
        fi
    fi

    # Remove symlink if exists (migration from old approach)
    [ -L "$FISH_PLUGINS_DST" ] && rm "$FISH_PLUGINS_DST"

    # Copy dotfiles version (authoritative)
    cp "$FISH_PLUGINS_SRC" "$FISH_PLUGINS_DST"

    # Sync plugins
    info "Syncing Fisher plugins..."
    if run_logged "Fisher update" fish -c "fisher update"; then
        task "Fisher plugins synced"
    else
        warn "Fisher update failed (see $LOG_FILE)"
    fi
else
    warn "Fish not installed, skipping Fisher setup"
fi

# ─────────────────────────────────────────────────────────────
header "npm Global Packages"

# npm globals go to ~/.npm-global (configured via .npmrc prefix)
# Uses node from pnpm (set up in Node.js section above)
if has_cmd npm; then
    mkdir -p "$HOME/.npm-global/bin"
    info "Installing global packages to ~/.npm-global..."
    install_from_list "$HERE/npm/global-packages.txt" \
        'npm list -g "$item" 2>/dev/null' \
        'npm install -g "$item"'
    info "Upgrading global packages to latest..."
    if run_logged "npm update -g" npm update -g; then
        task "Global packages upgraded"
    else
        warn "npm update -g failed (see $LOG_FILE)"
    fi
else
    warn "npm not installed, skipping global packages"
fi

# Enable corepack for per-project pnpm/yarn version management
if has_cmd corepack; then
    # Check if corepack shims already exist
    if [ -L "$PNPM_HOME/pnpm" ] || [ -L "$(dirname "$(which node)")/pnpm" ] 2>/dev/null; then
        skip "Corepack"
    else
        if run_logged "corepack enable" corepack enable; then
            task "Corepack enabled"
        else
            warn "corepack enable failed (see $LOG_FILE)"
        fi
    fi
fi

# ─────────────────────────────────────────────────────────────
# macOS-specific
# ─────────────────────────────────────────────────────────────

if [ "$(uname)" = "Darwin" ]; then
    header "macOS Defaults"

    # Track if any defaults changed (for Finder restart)
    DEFAULTS_CHANGED=false

    info "Configuring keyboard..."
    set_default "NSGlobalDomain" "ApplePressAndHoldEnabled" "-bool" "false" "Key repeat enabled"
    set_default "NSGlobalDomain" "KeyRepeat" "-int" "2" "Fast key repeat rate"
    set_default "NSGlobalDomain" "InitialKeyRepeat" "-int" "15" "Short initial key repeat delay"
    set_default "NSGlobalDomain" "NSAutomaticPeriodSubstitutionEnabled" "-bool" "false" "Disabled double-space period"
    set_default "NSGlobalDomain" "NSAutomaticQuoteSubstitutionEnabled" "-bool" "false" "Disabled smart quotes"
    set_default "NSGlobalDomain" "NSAutomaticDashSubstitutionEnabled" "-bool" "false" "Disabled smart dashes"
    set_default "NSGlobalDomain" "NSAutomaticSpellingCorrectionEnabled" "-bool" "false" "Disabled auto-correct"
    set_default "NSGlobalDomain" "AppleKeyboardUIMode" "-int" "3" "Full keyboard access (Tab in dialogs)"

    info "Configuring Finder..."
    set_default "NSGlobalDomain" "AppleShowAllExtensions" "-bool" "true" "Show all file extensions"
    set_default "com.apple.finder" "FXEnableExtensionChangeWarning" "-bool" "false" "No extension change warning"
    set_default "com.apple.finder" "AppleShowAllFiles" "-bool" "true" "Show hidden files"
    set_default "com.apple.finder" "ShowPathbar" "-bool" "true" "Show path bar"
    set_default "com.apple.finder" "_FXSortFoldersFirst" "-bool" "true" "Folders on top when sorting"
    set_default "com.apple.desktopservices" "DSDontWriteNetworkStores" "-bool" "true" "No .DS_Store on network volumes"
    set_default "com.apple.desktopservices" "DSDontWriteUSBStores" "-bool" "true" "No .DS_Store on USB volumes"

    info "Configuring system..."
    set_default "com.apple.LaunchServices" "LSQuarantine" "-bool" "false" "Disabled app quarantine dialog"
    set_default "com.apple.dock" "minimize-to-application" "-bool" "true" "Minimize to app icon"
    set_default "com.apple.dock" "show-recents" "-bool" "false" "No recent apps in Dock"
    set_default "com.apple.dock" "autohide" "-bool" "true" "Dock autohide"
    set_default "com.apple.dock" "tilesize" "-int" "36" "Dock icon size (smaller)"
    set_default "com.apple.dock" "mineffect" "-string" "scale" "Scale effect (not genie)"

    info "Configuring trackpad..."
    set_default "com.apple.AppleMultitouchTrackpad" "Clicking" "-bool" "true" "Tap to click (trackpad)"
    set_default "com.apple.driver.AppleBluetoothMultitouch.trackpad" "Clicking" "-bool" "true" "Tap to click (bluetooth)"

    info "Configuring Mission Control..."
    set_default "com.apple.dock" "mru-spaces" "-bool" "false" "Disable auto-rearrange Spaces"

    info "Checking iCloud Desktop & Documents..."
    icloud_desktop=$(defaults read com.apple.finder FXICloudDriveDesktop 2>/dev/null || echo "0")
    icloud_docs=$(defaults read com.apple.finder FXICloudDriveDocuments 2>/dev/null || echo "0")
    if [ "$icloud_desktop" = "1" ] && [ "$icloud_docs" = "1" ]; then
        skip "iCloud Desktop & Documents"
    else
        warn "iCloud Desktop & Documents not enabled - enable manually:"
        printf "      ${DIM}open \"x-apple.systempreferences:com.apple.preferences.AppleIDPrefPane\"${RESET}\n"
        printf "      ${DIM}iCloud → iCloud Drive → Options → check \"Desktop & Documents Folders\"${RESET}\n"
    fi

    # ─────────────────────────────────────────────────────────────
    header "Dock Apps"

    DOCK_CHANGED=false
    if has_cmd dockutil; then
        DOCK_CONFIG="$HERE/dock/apps.txt"
        if [ -f "$DOCK_CONFIG" ]; then
            # Get current dock apps
            current_dock=$(dockutil --list 2>/dev/null | awk -F$'\t' '{print $1}' | tr '\n' '|' | sed 's/|$//')

            # Build expected dock apps list
            expected_dock=""
            while IFS= read -r app || [ -n "$app" ]; do
                [[ "$app" =~ ^#.*$ || -z "$app" || "$app" =~ ^[[:space:]]*$ ]] && continue
                app=$(echo "$app" | xargs)
                [ -n "$expected_dock" ] && expected_dock="$expected_dock|"
                expected_dock="$expected_dock$app"
            done < "$DOCK_CONFIG"

            if [ "$current_dock" = "$expected_dock" ]; then
                skip "Dock apps"
            else
                info "Configuring Dock apps..."

                # Clear existing dock (except Finder and Trash which are automatic)
                dockutil --remove all --no-restart 2>/dev/null || true

                # Add apps from config
                while IFS= read -r app || [ -n "$app" ]; do
                    [[ "$app" =~ ^#.*$ || -z "$app" || "$app" =~ ^[[:space:]]*$ ]] && continue
                    app=$(echo "$app" | xargs)

                    # Try to find the app
                    app_path=""
                    for dir in "/Applications" "/System/Applications" "$HOME/Applications"; do
                        if [ -d "$dir/$app.app" ]; then
                            app_path="$dir/$app.app"
                            break
                        fi
                    done

                    if [ -n "$app_path" ]; then
                        dockutil --add "$app_path" --no-restart 2>/dev/null && DOCK_CHANGED=true || warn "Failed to add $app"
                    else
                        warn "App not found: $app"
                    fi
                done < "$DOCK_CONFIG"

                if $DOCK_CHANGED; then
                    task "Dock apps configured (restart Dock to apply)"
                fi
            fi
        else
            skip "Dock config (no dock/apps.txt)"
        fi
        # Add Downloads folder to "others" section (right side, next to Trash)
        if dockutil --list | grep -q "Downloads"; then
            skip "Downloads in Dock"
        else
            dockutil --add "$HOME/Downloads" --section others --view fan --display folder --no-restart 2>/dev/null
            DOCK_CHANGED=true
            task "Downloads added to Dock"
        fi
    else
        warn "dockutil not installed, skipping Dock configuration"
    fi

    # Show manual restart hint if dock was modified
    if $DOCK_CHANGED; then
        info "Dock changes apply on login, or run: killall Dock"
    fi

    # ─────────────────────────────────────────────────────────────
    # Hint about Finder restart if settings changed
    if $DEFAULTS_CHANGED; then
        info "Finder settings apply on login, or run: killall Finder"
    fi
fi

fi  # End of: if ! $MIGRATE_ONLY

# ─────────────────────────────────────────────────────────────
# Migrations (only with --migrate flag)
# ─────────────────────────────────────────────────────────────

if $RUN_MIGRATE; then
    header "Migrations"

    MIGRATIONS_DIR="$HERE/migrations"
    MARKER_FILE="$MIGRATIONS_DIR/.marker"
    LAST_RUN=$(cat "$MARKER_FILE" 2>/dev/null || echo "0000-00-00")

    if [ ! -d "$MIGRATIONS_DIR" ] || [ -z "$(ls -A "$MIGRATIONS_DIR"/*.sh 2>/dev/null)" ]; then
        skip "No migrations found"
    else
        # Find pending migrations
        PENDING=()
        for script in "$MIGRATIONS_DIR"/*.sh; do
            [ -f "$script" ] || continue
            TIMESTAMP=$(basename "$script" | grep -oE '^[0-9]{4}-[0-9]{2}-[0-9]{2}' || echo "")
            if [ -n "$TIMESTAMP" ] && [[ "$TIMESTAMP" > "$LAST_RUN" ]]; then
                PENDING+=("$script")
            fi
        done

        if [ ${#PENDING[@]} -eq 0 ]; then
            skip "No pending migrations (last run: $LAST_RUN)"
        else
            info "Found ${#PENDING[@]} pending migration(s):"
            for script in "${PENDING[@]}"; do
                printf "    ${DIM}%s${RESET}\n" "$(basename "$script")"
            done
            printf "\n"
            printf "  ${YELLOW}Run these migrations?${RESET} [y/N] "
            read -r confirm
            if [[ "$confirm" =~ ^[Yy]$ ]]; then
                for script in "${PENDING[@]}"; do
                    info "Running $(basename "$script")..."
                    if bash "$script" >> "$LOG_FILE" 2>&1; then
                        task "$(basename "$script")"
                        # Update marker after each successful migration
                        TIMESTAMP=$(basename "$script" | grep -oE '^[0-9]{4}-[0-9]{2}-[0-9]{2}')
                        echo "$TIMESTAMP" > "$MARKER_FILE"
                    else
                        warn "Migration failed: $(basename "$script") (see $LOG_FILE)"
                        break
                    fi
                done
            else
                info "Migrations skipped"
            fi
        fi
    fi
fi

# ─────────────────────────────────────────────────────────────
# Done
# ─────────────────────────────────────────────────────────────

printf "\n"
if $MIGRATE_ONLY; then
    printf "${BOLD}${GREEN}╔══════════════════════════════════════╗${RESET}\n"
    printf "${BOLD}${GREEN}║${RESET}        ${BOLD}${GREEN}✓ Migrations Complete${RESET}        ${BOLD}${GREEN}║${RESET}\n"
    printf "${BOLD}${GREEN}╚══════════════════════════════════════╝${RESET}\n"
    printf "\n"
    exit 0
fi

printf "${BOLD}${GREEN}╔══════════════════════════════════════╗${RESET}\n"
printf "${BOLD}${GREEN}║${RESET}           ${BOLD}${GREEN}✓ Sync Complete${RESET}           ${BOLD}${GREEN}║${RESET}\n"
printf "${BOLD}${GREEN}╚══════════════════════════════════════╝${RESET}\n"

# Remind about SSH keys if missing
if [ ! -f "$HOME/.ssh/id_ed25519" ] && [ ! -f "$HOME/.ssh/id_rsa" ]; then
    printf "\n"
    printf "${YELLOW}${BOLD}Note:${RESET} No SSH keys found. Generate with:\n"
    printf "  ${CYAN}ssh-keygen -t ed25519 -C \"jasonkuhrt@me.com\"${RESET}\n"
    printf "  ${CYAN}gh ssh-key add ~/.ssh/id_ed25519.pub${RESET}\n"
fi

# Remind about sudo setup (only if needed)
if sync_sudo_needed; then
    printf "\n"
    printf "${BOLD}Next:${RESET} Run ${CYAN}sudo ./sync-sudo${RESET} for:\n"
    $SUDO_NEEDED_PMSET && printf "  ${DIM}• Power management (display sleep)${RESET}\n"
    $SUDO_NEEDED_TOUCHID && printf "  ${DIM}• Touch ID for sudo${RESET}\n"
    ($SUDO_NEEDED_SHELLS || $SUDO_NEEDED_CHSH) && printf "  ${DIM}• Fish as default shell${RESET}\n"
    printf "\n"
fi
