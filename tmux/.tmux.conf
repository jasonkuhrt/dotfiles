# ═══════════════════════════════════════════════════════════
# tmux config
# See README.md for crash course & reference
# ═══════════════════════════════════════════════════════════

# ─────────────────────────────────────────────────────────────
# General
# ─────────────────────────────────────────────────────────────

# Enable true color support
set -g default-terminal "tmux-256color"
set -ag terminal-overrides ",xterm-256color:RGB"
set -ag terminal-overrides ",*:Tc"

# Enable mouse support
set -g mouse on

# ─ Scroll tuning (tmux can't do native smooth scroll, but we can improve it)
#
# 1. Faster scroll: more lines per wheel tick (default is 5)
bind -T copy-mode-vi WheelUpPane   send-keys -X -N 3 scroll-up
bind -T copy-mode-vi WheelDownPane send-keys -X -N 3 scroll-down

# 2. Alternate screen override (DISABLED - causes scroll issues with Claude Code TUI)
#    This made vim/less content persist after exit, but breaks TUI apps that
#    rely on alternate screen for proper rendering.
# set -g terminal-overrides ',*:smcup@:rmcup@'

# 3. Exit copy-mode when scrolling past bottom (feels more natural)
bind -T copy-mode-vi WheelDownPane select-pane \; send-keys -X -N 3 scroll-down

# Start windows and panes at 1, not 0
set -g base-index 1
setw -g pane-base-index 1

# Renumber windows when one is closed
set -g renumber-windows on

# Faster escape time (better for vim)
set -sg escape-time 10

# Increase history limit
set -g history-limit 50000

# Focus events (for vim autoread)
set -g focus-events on

# ─────────────────────────────────────────────────────────────
# Prefix
# ─────────────────────────────────────────────────────────────

# Keep ctrl-b as prefix (muscle memory friendly)
# Alternative: ctrl-a (screen-style) or ctrl-space
# set -g prefix C-'
# unbind C-'
# bind C-' send-prefix

# ─────────────────────────────────────────────────────────────
# Vim-style pane navigation
# ─────────────────────────────────────────────────────────────

# hjkl pane switching (after prefix)
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Vim-style splits (more intuitive than % and ")
bind s split-window -v -c "#{pane_current_path}"
bind v split-window -h -c "#{pane_current_path}"

# Resize panes with HJKL (after prefix)
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# ─────────────────────────────────────────────────────────────
# Vim-style copy mode
# ─────────────────────────────────────────────────────────────

# Use vi keys in copy mode
setw -g mode-keys vi

# Enter copy mode with prefix + [
# v to start selection, y to yank
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel

# Rectangular selection with ctrl-v
bind -T copy-mode-vi C-v send-keys -X rectangle-toggle

# ─────────────────────────────────────────────────────────────
# Window management
# ─────────────────────────────────────────────────────────────

# New window in current path
bind c new-window -c "#{pane_current_path}"

# Quick window switching
bind -r n next-window
bind -r p previous-window

# ─────────────────────────────────────────────────────────────
# Quality of life
# ─────────────────────────────────────────────────────────────

# Reload config (XDG path)
bind r source-file ~/.config/tmux/tmux.conf \; display "Config reloaded"

# Clear screen and history
bind C-l send-keys 'C-l'

# ─────────────────────────────────────────────────────────────
# Status bar (minimal)
# ─────────────────────────────────────────────────────────────

set -g status-style 'bg=default,fg=white'
set -g status-left '#[fg=cyan]#S '
set -g status-right '#(gitmux -cfg ~/.config/gitmux/gitmux.conf "#{pane_current_path}")'
set -g status-left-length 20
set -g status-right-length 60
setw -g window-status-current-style 'fg=cyan,bold'
setw -g window-status-current-format '#I:#W'
setw -g window-status-format '#I:#W'

# ─────────────────────────────────────────────────────────────
# Plugins (tpm-redux)
# ─────────────────────────────────────────────────────────────

# Session persistence
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @continuum-restore 'on'

# Session switching
set -g @plugin 'omerxx/tmux-sessionx'
set -g @sessionx-bind 'o'
set -g @sessionx-zoxide-mode 'on'

# fzf integration for tmux management (prefix + F)
set -g @plugin 'sainnhe/tmux-fzf'
TMUX_FZF_LAUNCH_KEY="f"
TMUX_FZF_OPTIONS="-p -w 62% -h 38% -m"

# URL picker from scrollback (prefix + u)
set -g @plugin 'wfxr/tmux-fzf-url'
set -g @fzf-url-history-limit '2000'

# Initialize tpm (keep at bottom)
run '~/.config/tmux/plugins/tpm/tpm'
